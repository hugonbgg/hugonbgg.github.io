<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapeamento das Barragens</title>
  <!-- Carrega as libs do mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Carrega o plugin de geocoding -->
  <script
    src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
    type="text/css" />
  <!-- Carrega o bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
    integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
    crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #notas {
      position: absolute;
      bottom: 30px;
      left: 10px;

      width: fit-content;
      max-width: 70%;
      height: fit-content;
      padding: 8px;
      background-color: rgba(249, 250, 250, 0.75);
      color: #065596ee;
      font-size: 13px;
      border-radius: 20px;
      text-align: justify;
      font-family: "Open Sans", Helvetica, sans-serif;
    }

    /* Position the buttons in the bottom-right corner and align them to the right */
    .button-container {
      position: absolute;
      bottom: 30px;
      right: 10px;
      width: auto;
      height: auto;
      color: #555555;
      font-family: "Open Sans", Helvetica, sans-serif;
      font-size: 14px;

      line-height: 22px;
      padding: 8px;
      background-color: rgba(255, 255, 255, 0.75);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 16px;
    }

    .logos-barragens {
      display: flex;
      align-items: center;
    }

    .logos-barragens p {
      margin-right: 10px;
    }

    .logos-barragens .imagens {
      width: 30px;
      height: 30px;
      vertical-align: middle;
      margin-left: 0px;
      margin-bottom: 3px;
    }

    .mapboxgl-ctrl-geocoder {
      width: 310px;
      height: auto;
      min-width: 100%;
      max-width: 200%;
      margin: 0;

    }

    .bg-brown {
      background-color: #8b4513;
    }
  </style>
</head>

<body>
  <!--Cria o div do mapa-->
  <div id="map"></div>
  <!--Cria o div da nota-->
  <div id="notas">
    <i><b>Categoria de risco:</b></i> indica a possibilidade da ocorrência de
    desastre ou outro tipo de falha<br>
    <i><b>Dano potencial:</b></i> indica a intensidade da destruição que pode ser causada por falha da barragem<br>
    <i><b>Fiscalização federal: </b></i>Indica se a construção está incluída na Política Nacional de Segurança de
    Barragens (PNSB)

  </div>

  <div class="button-container">

    <b><p>Áreas inundáveis</p></b>

    <div class="form-check-container">
      <div class="form-check form-switch">
        <input class="form-check-input opacity-10 bg-danger border border-danger" type="checkbox" role="switch"
          id="ZAS_switch" checked>
        <label class="form-check-label" for="flexSwitchCheckDefault">Zona afetada em até 30 minutos (ZAS)</label>
      </div>
    </div>

    <div class="form-check-container">
      <div class="form-check form-switch">
        <input class="form-check-input opacity-10 bg-warning border border-warning" type="checkbox" role="switch"
          id="ZSS_switch" checked>
        <label class="form-check-label" for="flexSwitchCheckChecked">Zona afetada em mais de 30 minutos (ZSS)</label>
      </div>
    </div>

    <div class="form-check-container">
      <div class="form-check form-switch">
        <input class="form-check-input opacity-10 " type="checkbox" role="switch"
          style="background-color:#A0522D; border-color: #A0522D;" id="manchas_switch" checked>
        <label class="form-check-label" for="flexSwitchCheckChecked">Zona afetada sem informação temporal</label>
      </div>
    </div>


    <div class="logos-barragens">
      <p>
        
        <img src="dados/barragem_com_dados.png" class="imagens" alt="Imagem de barragem"> Barragem com dados de áreas afetadas<br>
        
        <img src="dados/barragem_sem_dados.png" class="imagens" alt="Imagem de barragem"> Barragem sem dados de áreas afetadas
      </p>
    </div>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiaHVnb25iZyIsImEiOiJjanFza2JmaTQwZDllNDNyeGtub3VsODZ0In0.eYH5xYQqrhVWaKIndItTOw";
      const map = new mapboxgl.Map({
        container: "map", // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: "mapbox://styles/hugonbg/cle3eyejo00df01mty9rbk70o", // style URL
        center: [-55, -19], // starting position [lng, lat]
        zoom: 3.3, // starting zoom
        attributionControl: false
      });

      map.addControl(
        new mapboxgl.AttributionControl({

          customAttribution:
            '<a href="https://www.linkedin.com/in/hugonbg/">Mapa: Hugo Nicolau Barbosa de Gusmão</a>'
        })
      );


      map.on("load", function () {
        // Add the "ZAS" GeoJSON as a source
        map.addSource("zas", {
          type: "geojson",
          data: "dados/ZAS_simplify.json", // Replace with the file path of your "ZAS" GeoJSON file
        });

        // Add the "ZSS" GeoJSON as a source
        map.addSource("zss", {
          type: "geojson",
          data: "dados/ZSS_simplify.json", // Replace with the file path of your "ZSS" GeoJSON file
        });

        // Add the "ZSS" GeoJSON as a source
        map.addSource("manchas", {
          type: "geojson",
          data: "dados/mancha_geral_final.geojson", // Replace with the file path of your "ZSS" GeoJSON file
        });


        // Add a layer for the "ZAS" polygons
        map.addLayer({
          id: "manchas-polygons",
          type: "fill",
          source: "manchas",
          paint: {
            "fill-color": "brown",
            'fill-opacity': 0.7 // Set the opacity to 0 if the layer is not visible
          },
        });

        // Add a layer for the "ZSS" polygons
        map.addLayer({
          id: "zss-polygons",
          type: "fill",
          source: "zss",
          paint: {
            "fill-color": "orange",
            'fill-opacity': 0.7 // Set the opacity to 0 if the layer is not visible
          },
        });
        // Add a layer for the "ZAS" polygons
        map.addLayer({
          id: "zas-polygons",
          type: "fill",
          source: "zas",
          paint: {
            "fill-color": "red",
            'fill-opacity': 0.7 // Set the opacity to 0 if the layer is not visible
          },
        });



        //Carrega os icones das barragens

        map.loadImage("dados/barragem.png", function (error, image) {
          if (error) throw error;
          map.addImage("barragem_icone", image);
        });

        map.loadImage("dados/barragem_com_dados.png", function (error, image) {
          if (error) throw error;
          map.addImage("barragem_com_dados_icone", image);
        });
        map.loadImage("dados/barragem_sem_dados.png", function (error, image) {
          if (error) throw error;
          map.addImage("barragem_sem_dados_icone", image);
        });

        //Adiciona a camada das barragens
        map.addSource("barragens", {
          type: "geojson",
          data: "dados/barragens.geojson",
          cluster: true, // Enable clustering
          clusterMaxZoom: 8 // Maximum zoom level at which to cluster
        });
        /*
        map.addLayer({
          id: "barragens",
          type: "symbol",
          source: "barragens",
          layout: {
            "icon-image": "barragem_icone",
            "icon-size": 0.2,
            "icon-allow-overlap": false,
          },
          paint: {},
        });
        */
        //Adiciona o cluster das barragens
        map.addLayer({
          id: "barragens_cluster",
          type: "circle",
          source: "barragens",
          filter: ["has", "point_count"], // Only show clusters at small zoom levels
          paint: {
            "circle-color": "#1978c8",
            "circle-radius": [
              "step",
              ["get", "point_count"],
              15,
              10,
              20,
              25,
              30
            ],
            "circle-opacity": 0.7
          }
        });

        //Adiciona a contagem ao cluster
        map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'barragens',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': ['get', 'point_count_abbreviated'],
            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
            'text-size': 14
          },
          paint: {
            "text-color": "#ffffff"
          }
        });

        map.addLayer({
          id: "barragens",
          type: "symbol",
          source: "barragens",
          filter: ['!', ['has', 'point_count']], // Only show individual dams at large zoom levels
          layout: {
            "icon-image": [
              "case",
              ["==", ["get", "ManchaMapeada"], "Sim"],
              "barragem_com_dados_icone",
              "barragem_sem_dados_icone"
            ],
            "icon-size": [
              "interpolate",
              ["linear"],
              ["zoom"],
              8.1, 0,
              8.2, 0.4,
              15, 0.6
            ],
            "icon-allow-overlap": false
          },
          paint: {}
        });

        // inspect a cluster on click
        map.on('click', 'barragens_cluster', (e) => {
          const features = map.queryRenderedFeatures(e.point, {
            layers: ['barragens_cluster']
          });
          const clusterId = features[0].properties.cluster_id;
          map.getSource('barragens').getClusterExpansionZoom(
            clusterId,
            (err, zoom) => {
              if (err) return;

              map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: zoom
              });
            }
          );
        });
        //Cria e define os popups
        map.on("click", "barragens", function (e) {
          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(
              "<b>Nome da barragem:</b> " +
              e.features[0].properties.NomeBarragem +
              " (" +
              e.features[0].properties.codigo +
              ")" +
              "<br>" +
              "<b>Responsável:</b> " +
              e.features[0].properties.NomeEmpreendedor +
              "<br>" +
              "<b>Município:</b> " +
              e.features[0].properties.Municipio +
              "<br>" +
              "<b>Estado:</b> " +
              e.features[0].properties.UF +
              "<br>" +
              "<b>Minério:</b> " +
              e.features[0].properties.Minerio +
              "<br>" +
              "<b>Categoria de risco:</b> " +
              e.features[0].properties.CategoriaRisco +
              "<br>" +
              "<b>Dano potencial:</b> " +
              e.features[0].properties.DanoPotencial +
              "<br>" +
              "<b>Fiscalização federal:</b> " +
              e.features[0].properties.InseridaPNSBFormatada
            )
            .addTo(map);
        });

        //ZAS

        // Selecione o botão de alternância (switch) por seu ID
        const zasSwitch = document.querySelector('#ZAS_switch');

        // Adicione o ouvinte de evento de alteração (change) ao botão de alternância
        zasSwitch.addEventListener('change', function () {
          // Verifique se o botão de alternância está marcado (checked)
          if (this.checked) {
            // Se estiver marcado, defina a propriedade de pintura do Mapbox GLJS para 0.7
            map.setPaintProperty('zas-polygons', 'fill-opacity', 0.7);
          } else {
            // Caso contrário, defina a propriedade de pintura do Mapbox GLJS para 0
            map.setPaintProperty('zas-polygons', 'fill-opacity', 0);
          }
        });

        //ZSS

        // Selecione o botão de alternância (switch) por seu ID
        const zssSwitch = document.querySelector('#ZSS_switch');

        // Adicione o ouvinte de evento de alteração (change) ao botão de alternância
        zssSwitch.addEventListener('change', function () {
          // Verifique se o botão de alternância está marcado (checked)
          if (this.checked) {
            // Se estiver marcado, defina a propriedade de pintura do Mapbox GLJS para 0.7
            map.setPaintProperty('zss-polygons', 'fill-opacity', 0.7);
          } else {
            // Caso contrário, defina a propriedade de pintura do Mapbox GLJS para 0
            map.setPaintProperty('zss-polygons', 'fill-opacity', 0);
          }
        });

        //Manchas

        // Selecione o botão de alternância (switch) por seu ID
        const manchasSwitch = document.querySelector('#manchas_switch');

        // Adicione o ouvinte de evento de alteração (change) ao botão de alternância
        manchasSwitch.addEventListener('change', function () {
          // Verifique se o botão de alternância está marcado (checked)
          if (this.checked) {
            // Se estiver marcado, defina a propriedade de pintura do Mapbox GLJS para 0.7
            map.setPaintProperty('manchas-polygons', 'fill-opacity', 0.7);
          } else {
            // Caso contrário, defina a propriedade de pintura do Mapbox GLJS para 0
            map.setPaintProperty('manchas-polygons', 'fill-opacity', 0);
          }
        });


      });





      //Mudar o cursor para a 'mãozinha' quando fica em cima da camada escolhida

      map.on('mouseenter', 'barragens_cluster', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      //Mudar o cursor para o ponteiro quando sai de cima da camada escolhida
      map.on('mouseleave', 'barragens_cluster', () => {
        map.getCanvas().style.cursor = '';
      });

      //Mudar o cursor para a 'mãozinha' quando fica em cima da camada escolhida
      map.on("mouseenter", "barragens", function () {
        map.getCanvas().style.cursor = "pointer";
      });

      //Mudar o cursor para o ponteiro quando sai de cima da camada escolhida
      map.on("mouseleave", "barragens", function () {
        map.getCanvas().style.cursor = "";
      });

      // Adiciona o buscapador de localização ao mapa
      map.addControl(
        new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl: mapboxgl,
          placeholder: 'Veja se a sua localidade é afetada...',
          countries: 'br'

        })
      );

      //Adiciona os controles de navegação ao mapa
      map.addControl(new mapboxgl.NavigationControl());

      //Adiciona a localização do usuário ao mapa
      map.addControl(
        new mapboxgl.GeolocateControl({
          positionOptions: {
            enableHighAccuracy: true,
          },
        })


      );


    </script>
</body>

</html>